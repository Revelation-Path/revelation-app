//! User profile page

use leptos::prelude::*;
use leptos_router::components::A;

use crate::{
    components::{BottomNav, Header},
    state::AppState
};

stylance::import_crate_style!(styles, "src/styles/profile.module.css");

#[component]
pub fn Profile() -> impl IntoView {
    let state = expect_context::<AppState>();
    let user = state.user;

    view! {
        <div class=styles::page>
            <Header title="Профиль"/>

            <div class=styles::container>
                // User card
                <div class=styles::userCard>
                    <div class=styles::avatar>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class=styles::userInfo>
                        <h2 class=styles::userName>
                            {move || user.get().and_then(|u| u.name).unwrap_or_else(|| "Гость".to_string())}
                        </h2>
                        <p class=styles::userId>
                            "ID: " {move || state.user_id().to_string().chars().take(8).collect::<String>()} "..."
                        </p>
                    </div>
                </div>

                // Menu
                <div class=styles::section>
                    <h3 class=styles::sectionTitle>"Меню"</h3>
                    <div class=styles::sectionContent>
                        <MenuItem href="/settings" label="Настройки">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                            </svg>
                        </MenuItem>
                        <MenuItem href="/profile/favorites" label="Избранное">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
                            </svg>
                        </MenuItem>
                        <MenuItem href="/profile/history" label="История">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12 6 12 12 16 14"/>
                            </svg>
                        </MenuItem>
                    </div>
                </div>

                // Account
                <div class=styles::section>
                    <h3 class=styles::sectionTitle>"Аккаунт"</h3>
                    <div class=styles::sectionContent>
                        <MenuItem href="/profile/churches" label="Мои церкви">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M18 21V9l-6-4-6 4v12"/>
                                <path d="M12 1v4"/>
                                <path d="M9 5h6"/>
                                <path d="M9 21v-6h6v6"/>
                            </svg>
                        </MenuItem>
                        <MenuItem href="/profile/payments" label="Пожертвования">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/>
                                <line x1="1" y1="10" x2="23" y2="10"/>
                            </svg>
                        </MenuItem>
                    </div>
                </div>

                // Connect
                <div class=styles::section>
                    <h3 class=styles::sectionTitle>"Привязать аккаунт"</h3>
                    <div class=styles::sectionContent>
                        <ConnectItem label="Telegram" connected=false>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                            </svg>
                        </ConnectItem>
                        <ConnectItem label="Email" connected=false>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                <polyline points="22,6 12,13 2,6"/>
                            </svg>
                        </ConnectItem>
                        <ConnectItem label="Телефон" connected=false>
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                            </svg>
                        </ConnectItem>
                    </div>
                </div>
            </div>

            <BottomNav/>
        </div>
    }
}

#[component]
fn MenuItem(href: &'static str, label: &'static str, children: Children) -> impl IntoView {
    view! {
        <A href=href attr:class=styles::menuItem>
            <span class=styles::menuIcon>
                {children()}
            </span>
            <span class=styles::menuLabel>{label}</span>
            <span class=styles::menuArrow>
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="9 18 15 12 9 6"/>
                </svg>
            </span>
        </A>
    }
}

#[component]
fn ConnectItem(label: &'static str, connected: bool, children: Children) -> impl IntoView {
    view! {
        <button class=styles::connectBtn disabled=connected>
            <span class=styles::menuIcon>
                {children()}
            </span>
            <span class=styles::menuLabel>{label}</span>
            {if connected {
                view! {
                    <span class=styles::connectStatusDone>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                             stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        "Подключено"
                    </span>
                }.into_any()
            } else {
                view! {
                    <span class=styles::connectStatus>"Подключить"</span>
                }.into_any()
            }}
        </button>
    }
}
